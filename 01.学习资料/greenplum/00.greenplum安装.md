# 在centos6.5单机安装greenplum6.0
## 环境：
+ 服务器版本：centos 6.5
+ 数据库版本：greenplum-db-6.0.0-rhel6-x86_64.rpm

## 安装glibc 2.14
查看支持的 gblic 版本

    strings /lib64/libc.so.6 | grep GLIBC
安装编译glibbc-2.14

    wget http://ftp.gnu.org/gnu/glibc/glibc-2.14.tar.gz
    wget http://ftp.gnu.org/gnu/glibc/glibc-ports-2.14.tar.gz
    tar xf glibc-2.14.tar.gz
    tar -xvf glibc-ports-2.14.tar.gz
    mv glibc-ports-2.14 glibc-2.14/ports
    cd glibc-2.14
    mkdir build
    cd build
    ../configure --prefix=/opt/glibc-2.14
    make -j4 && make install

问题："/root/glibc-2.14/build/elf/ldconfig: Can't open configuration file /usr/local/glibc-2.14/etc/ld.so.conf: No such file or directory"
解决：

    cp /etc/ld.so.c* /usr/local/glibc-2.14/etc/
    rm -rf /lib64/libc.so.6
操作删除软链接后系统无法操作任何命令，我们需要复制下面的命令执行后才可以

    LD_PRELOAD=/usr/local/glibc-2.14/lib/libc-2.14.so
    ln -s /usr/local/glibc-2.14/lib/libc-2.14.so /lib64/libc.so.6
编译好后，再查看一下GLIBC

    strings /lib64/libc.so.6 | grep GLIBC

## 创建用户和组gpadmin
    groupadd -g  3030 gpadmin
    useradd -u 3030 gpadmin -g gpadmin -d /home/gpadmin
    passwd gpadmin
## 配置内核参数，添加如下内容：
    vi /etc/sysctl.conf

    net.ipv4.ip_forward = 0
    net.ipv4.conf.default.accept_source_route = 0    
    kernel.sysrq = 1    
    kernel.core_uses_pid = 1    
    net.ipv4.tcp_syncookies = 1    
    kernel.msgmnb = 65536    
    kernel.msgmax = 65536    
    kernel.sem = 250 64000 100 512    
    kernel.shmmax = 500000000    
    kernel.shmmni = 4096    
    kernel.shmall = 4000000000    
    kernel.sem = 250 64000 100 512    
    net.ipv4.tcp_tw_recycle=1    
    net.ipv4.tcp_max_syn_backlog=4096    
    net.core.netdev_max_backlog=10000    
    vm.overcommit_memory=2    
    net.ipv4.conf.all.arp_filter = 1
以上参数可以根据自己系统配置做适当修改手工执行命令，让参数生效

    sysctl -p

在limits.conf文件中添加如下配置

    vi /etc/security/limits.conf
    * soft nofile 65536    
    * hard nofile 65536    
    * soft nproc 131072    
    * hard nproc 131072

配置用户ssh用户无密码登录，单机也得配置

    [root@mdw ~]# su - gpadmin    
    [gpadmin@mdw ~]$ mkdir ~/.ssh    
    [gpadmin@mdw ~]$ chmod 700 ~/.ssh    
    [gpadmin@mdw ~]$ cd .ssh/    
    [gpadmin@mdw .ssh]$ ssh-keygen -t rsa    
    [gpadmin@mdw .ssh]$ ssh mdw cat /home/gpadmin/.ssh/id_rsa.pub >>authorized_keys    
    [gpadmin@mdw .ssh]$ chmod 600 authorized_keys    
    [gpadmin@mdw .ssh]$ ssh mdw date
关闭防火墙

    service iptables stop
    ntsysv

    --上下键：可以在中间的方框当中，在各个服务之间移动；
    --空格键：可以用来选择你所需要的服务，[*]表示开起启动；
    --tab键：可以在方框、OK、Cancel之间移动；
    --[F1]键：可以显示该服务的说明。
关闭SELINUX,/etc/selinux/config

    	SELINUX=disabled
## 安装GP软件

    yum install krb5-devel libevent libyaml
    rpm -ivh greenplum-db-6.0.0-rhel6-x86_64.rpm
创建instance需要的目录

    [root@mdw ~]# mkdir -p /app/master
    [root@mdw ~]# mkdir -p /app/data/gp1
    [root@mdw ~]# mkdir -p /app/data/gp2
    [root@mdw ~]# mkdir -p /app/data/gp3
    [root@mdw ~]# mkdir -p /app/data/gp4
修改目录属主：

    [root@mdw ~]# chown -R gpadmin:gpadmin /usr/local/greenplum-db*
    [root@mdw ~]# chown -R gpadmin:gpadmin /app/master
    [root@mdw ~]# chown -R gpadmin:gpadmin /app/data/gp1
    [root@mdw ~]# chown -R gpadmin:gpadmin /app/data/gp2
    [root@mdw ~]# chown -R gpadmin:gpadmin /app/data/gp3
    [root@mdw ~]# chown -R gpadmin:gpadmin /app/data/gp4
修改gpadmin用户环境配置：

    [root@mdw ~]# su - gpadmin
    [gpadmin@mdw ~]$ vi .bash_profile

    source /usr/local/greenplum-db/greenplum_path.sh
    export MASTER_DATA_DIRECTORY=/app/master/gpseg-1
    export PGPORT=5432
    export PGUSER=gpadmin
    export PGDATABASE=mdw

gpadmin用户环境配置生效：

    [gpadmin@mdw ~]$ source .bash_profile
编辑all_hosts_file文件，添加如下内容：

    [gpadmin@mdw ~]$ vi all_hosts_file
    mdw
执行如下命令验证用户等效性

    [gpadmin@mdw ~]$ gpssh-exkeys -f all_hosts_file

## 初始化系统：

编辑系统初始化的参数文件，这个文件的编辑可以使用模版，模板文件所在目录如下：

    [gpadmin@mdw ~]$ cp /usr/local/greenplum-db/docs/cli_help/gpconfigs/gpinitsystem_config /home/gpadmin/
编辑gp参数文件，修改如下配置：

    [gpadmin@mdw ~]$ vi gpinitsystem_config

    declare -a DATA_DIRECTORY=(/app/data/gp1 /app/data/gp2 /app/data/gp3 /app/data/gp4)
    MASTER_HOSTNAME=mdw
    MASTER_DIRECTORY=/app/master
    DATABASE_NAME=mdw
编辑seg_hosts_file文件

    [gpadmin@mdw ~]$ vi seg_hosts_file
    mdw
执行初始化系统命令：

    [gpadmin@mdw ~]$ gpinitsystem -c gpinitsystem_config -h seg_hosts_file
系统开始初始化，之后会看到如下提示：
Continue with Greenplum creation Yy/Nn>
输入 Y ，按回车，系统会初始化完成
## 安装结束,连接GP数据库：

    [gpadmin@mdw ~]$ psql -d mdw
    psql (8.2.15)
    Type "help" for help.
    mdw=#

创建数据库

    [gpadmin@mdw ~]$ create database testDB;
给数据库权限

    [gpadmin@mdw ~]$ psql -d mdw
    psql (8.2.15)
    Type "help" for help.
    mdw=# \c testDB
    You are now connected to database "testDB" as user "gpadmin".
    testDB=# alter role gpadmin with password 'gpadmin';
远程权限

    [gpadmin@mdw ~]$ cd $MASTER_DATA_DIRECTORY/
    [gpadmin@mdw gpseg-1]$ ls
    base               pg_distributedlog     pg_stat_tmp            pg_xlog
    global             pg_distributedxidmap  pg_subtrans            postgresql.conf
    gp_dbid            pg_hba.conf           pg_tblspc              postmaster.opts
    gpperfmon          pg_ident.conf         pg_twophase            postmaster.pid
    pg_changetracking  pg_log                pg_utilitymodedtmredo
    pg_clog            pg_multixact          PG_VERSION
    [gpadmin@gpmaster gpseg-1]$
    [gpadmin@gpmaster gpseg-1]$ vi pg_hba.conf
    host     testDB      gpadmin         192.168.96.1/32    md5
通过gpstop -u命令使配置生效

    [gpadmin@mdw gpseg-1]$ gpstop -u
通过其他机器登录数据库

    $ psql -h 192.168.100.138 -p 5432 -d testDB -U gpadmin

## 安装gpperfmon-cc-web监控
1、首先用gpadmin用户登录：

    su - gpadmin
2、在master主机上执行source：

    source /usr/local/greenplum-db/greenplum_path.sh
3、使用gpperfmon_install命令，安装后会建立gpperfmon数据库，默认用户gpmon：

    gpperfmon_install --enable --password gpmon --port 5432
4、重启数据库：

    gpstop -r
5、使用ps命令检查数据收集进程是否运行：

    ps -ef | grep gpmmon
6、执行命令检查数据收集进程是否写入命令中心数据库：

    psql gpperfmon -c 'SELECT * FROM system_now;'
7、配置standby master主机：

    复制 $MASTER_DATA_DIRECTORY/pg_hba.conf 文件从你的master主机到standby主机：
    gpscp -h smdw /home/gpamdin/masterdata/gpseg-1/pg_hba.conf =:$MASTER_DATA_DIRECTORY/
    复制 ~/.pgpass 文件从你的master主机到standby主机：
    gpscp -h smdw ~/.pgpass =:~/
    注：.pgpass 权限必须要设置成600。
8、配置环境
所有节点的权限
把 /usr/local/ 的权限设置成gpadmin

    chown -R gpadmin:gpadmin greenplum-cc-web

/data/gpdata/master/gpseq-1/pg_hba.conf，在最后加上

    host    gpperfmon       gpmon   ::1/128 md5
    host    gpperfmon       gpmon   0.0.0.0/0 md5
9、安装

    gpccinstall
    	Do you agree to the Pivotal Greenplum Command Center End User License Agreement? Yy/Nn (Default=Y)
    	Where would you like to install Greenplum Command Center? (Default=/usr/local)
    	What would you like to name this installation of Greenplum Command Center? (Default=gpcc)
    	What port would you like gpcc webserver to use? (Default=28080)
    	Would you like to enable kerberos? Yy/Nn (Default=N)
    	Would you like enable SSL? Yy/Nn (Default=N)
.bash_profile，添加下面两行

    GPPERFMONHOME=/usr/local/greenplum-cc-web-4.4.2
    source $GPPERFMONHOME/gpcc_path.sh
gpadmin用户环境配置生效：

    [gpadmin@mdw ~]$ source .bash_profile
10、启动

    gpcc start
